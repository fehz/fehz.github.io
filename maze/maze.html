<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrinthe</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="reset.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/fontawesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/brands.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/solid.css" rel="stylesheet" />

    <link rel="stylesheet" href="style.css">
    <script src="game.js"></script>
    <title>Hello</title>
    <style>
        a {
            cursor: pointer;
        }
    </style>
</head>

<body onload="showloadingScreen()">
    <div id="instructions-container">
        <div id="instructions">
            <h2>Ah zut! Quel tête en l'air je suis!!&#128557;<br />&nbsp;</h2>
            J'avais un paquet pour toi, mais je ne sais plus où je l'ai mis<br />
            En me rendant ici, je suis passé par la clairière juste derrière la ville. C'est un très bel endroit.</br />
            J'ai peur de l'avoir fait tomber pendant ma balade.<br />
            <br />
            Je suis vraiment désolé. <br />
            <br />
            Il va faire bientot nuit en plus...<br />
            <br />
            J'abuse un peu, mais veux-tu m'aider à retrouver le paquet? A nous deux on sera plus rapide&#128519;<br />
        </div>
        <div class="tips">Appuie sur <a onclick="startGame()">"Entree"</a> ou <a onclick="startGame()">"ici"</a> pour
            aider cette tête en l'air
            &#128554;<br />&nbsp;</div>
    </div>
    <div class="player-container">
        <canvas id="playground" tabindex="1">

        </canvas>
        <!-- D-pad : flèches de direction -->
        <div class="dpad hidden" role="group" id="pad-control">
            <button class="btn up" onclick="moveTo('U')"><span>▲/Z</span></button>
            <button class="btn left" onclick="moveTo('L')"><span>◀/Q</span></button>
            <button class="btn right" onclick="moveTo('R')"><span>▶/D</span></button>
            <button class="btn down" onclick="moveTo('D')"><span>▼/S</span></button>
        </div>
    </div>

    <p id="infos-block"></p>
    <script>
        var devMode = false;
        var infosBlock = document.getElementById('infos-block');

        var gamesData;
        var context;
        var loadingScreenImage = new Image();
        loadingScreenImage.src = './assets/menu.png';
        var wall = new Image();
        wall.src = './assets/wall.png';
        var grass = new Image();
        grass.src = './assets/grass-2.png';
        var perso = new Image();
        perso.src = './assets/perso-3.png';
        var flowers = [];
        flowers[0] = new Image();
        flowers[0].src = './assets/flower-1.png';
        flowers[1] = new Image();
        flowers[1].src = './assets/flower-2.png';
        flowers[2] = new Image();
        flowers[2].src = './assets/flower-3.png';
        flowers[3] = new Image();
        flowers[3].src = './assets/flower-4.png';
        var pets = [];
        pets[0] = new Image();
        pets[0].src = './assets/shiba.png';
        pets[1] = new Image();
        pets[1].src = './assets/cat.png';

        var gift = new Image();
        gift.src = './assets/gift.png';

        var heart = new Image();
        heart.src = './assets/heart.png';
        var perso2 = new Image();
        perso2.src = './assets/perso2.png';
        

        function initDatas() {
            var mazeData = pickRandom(_mazes);
            gamesData = {
                maze: mazeData.maze,
                startPosition: mazeData.startPosition,
                targetPosition: mazeData.targetPosition,
                blockSize: 64,
                canMoveTo: function (position) {
                    try {
                        return '.' === this.maze[position.y][position.x];
                    }
                    catch (e) {
                        console.log("out of bound index");
                        return false;
                    }
                },
                actualPosition: { x: 0, y: 0 },
                canvasWidth: function () {
                    return this.blockSize * this.maze[0].length;
                },
                canvasHeight: function () {
                    return this.blockSize * this.maze.length;
                }
            }
            gamesData.actualPosition = gamesData.startPosition;
            const canvas = document.getElementById("playground");
            canvas.width = this.gamesData.canvasWidth();
            canvas.height = this.gamesData.canvasHeight();
            canvas.style.backgroundColor = 'gray';
            this.context = canvas.getContext("2d");

        }

        function startGame() {
            document.removeEventListener('keydown', handleEventOnLoadingScreen)
            initDatas();
            initMaze();
            initEventListener();
            var padControl = document.getElementById('pad-control');
            padControl.classList.remove('hidden');
            var instructions = document.getElementById('instructions-container');
            instructions.classList.add('hidden');

        }

        function showloadingScreen() {
            const canvas = document.getElementById("playground");
            canvas.width = 400;
            canvas.height = 1;
            canvas.style.backgroundColor = 'white';
            initEventListenerOnLoadingScreen();
        }

        initEventListenerOnLoadingScreen = () => {
            document.addEventListener('keydown', handleEventOnLoadingScreen, false);
        }

        handleEventOnLoadingScreen = (event) => {
            console.log(event);
            switch (event.key) {
                case 'Enter':
                    startGame();
                    break;
            }
        }

        function initMaze() {
            drawMaze();
            drawGift(this.gamesData.targetPosition);
            drawPerso(this.gamesData.startPosition);
        }

        function initEventListener() {
            document.addEventListener('keydown', handleMoveEvent, false);
        }

        handleMoveEvent = (event) => {
            if (this.devMode) {
                console.log(event);
            }
            switch (event.key) {
                case 'ArrowUp':
                case 'z':
                    moveTo('U');
                    break;
                case 'ArrowDown':
                case 's':
                    moveTo('D');
                    break;
                case 'ArrowLeft':
                case 'q':
                    moveTo('L');
                    break;
                case 'ArrowRight':
                case 'd':
                    moveTo('R');
                    break;
            }
        }

        function updatePosition(persoPostion) {
            drawCase(this.gamesData.actualPosition, "gray");
            drawGift(this.gamesData.targetPosition);
            drawPerso(persoPostion);
        }


        function drawMaze() {
            for (let [i, row] of this.gamesData.maze.entries()) {
                for (let [j, elt] of row.split('').entries()) {
                    if (elt === 'X') {
                        drawImage({ x: j, y: i }, this.grass);
                        drawFlower({ x: j, y: i });
                        drawPet({ x: j, y: i });
                    }
                    if (this.devMode) {
                        this.context.textBaseline = 'top';
                        this.context.fillStyle = 'black';
                        this.context.fillText(`${j}x${i}`, j * this.gamesData.blockSize, i * this.gamesData.blockSize);
                    }
                }

            }
        }
        drawFlower = (position) => {
            drawRandomAsset(position, this.flowers, 0.3);
        }
        drawPet = (position) => {
            drawRandomAsset(position, this.pets, 0.01);
        }

        drawRandomAsset = (position, assets, ratio) => {
            if (Math.random() < ratio) {
                const elt = pickRandom(assets);
                const blockSize = this.gamesData.blockSize;
                this.context.drawImage(elt,
                    position.x * blockSize + (Math.random() * (blockSize - elt.width)),
                    position.y * blockSize + (Math.random() * (blockSize - elt.height)));
            }
        }

        drawPerso = (position) => {
            drawImage(position, this.perso);
        }

        drawGift = (position) => {
            drawImage(position, this.gift);
        }
        drawCase = (position, style) => {
            const blockSize = this.gamesData.blockSize;
            this.context.fillStyle = style;
            this.context.fillRect(position.x * blockSize, position.y * blockSize, blockSize, blockSize);
            if (this.devMode) {
                this.context.textBaseline = 'top';
                this.context.fillStyle = 'black';
                this.context.fillText(`${position.x}x${position.y}`, position.x * blockSize, position.y * blockSize);
            }
        }

        drawImage = (position, image) => {
            const blockSize = this.gamesData.blockSize;
            this.context.drawImage(image, position.x * blockSize, position.y * blockSize);
            if (this.devMode) {
                this.context.textBaseline = 'top';
                this.context.fillStyle = 'black';
                this.context.fillText(`${position.x}x${position.y}`, position.x * blockSize, position.y * blockSize);
            }
        }
        moveTo = (direction) => {
            var target = structuredClone(this.gamesData.actualPosition);
            switch (direction) {
                case 'R':
                    target.x++;
                    break;
                case 'L':
                    target.x--;
                    break;
                case 'U':
                    target.y--;
                    break;
                case 'D':
                    target.y++;
                    break;
            }

            if (this.gamesData.canMoveTo(target)) {
                updatePosition(target);
                this.gamesData.actualPosition = target;
                verifyWinCondition();
            }
        }
        verifyWinCondition = () => {
            if (this.gamesData.actualPosition.x === this.gamesData.targetPosition.x &&
                this.gamesData.actualPosition.y === this.gamesData.targetPosition.y
            ) {
                if (this.devMode) {
                    this.infosBlock.innerHTML = 'YOU WIN'
                }
                launchOutro();
            }
        }

        pickRandom = (list) => {
            return list[Math.floor(Math.random() * list.length)];
        }

        launchOutro = () => {
            document.removeEventListener('keydown', handleMoveEvent)
            var fadeOutParams = {
                status: 0,
                step: 0.05,
                callback: showGift
            }
            fadeOut(fadeOutParams);
        }

        showGift = () => {
            heartBeatAnimation(true);
            //heartBeatAnimationv2(true,1,0.2);
            setTimeout(()=>{
                this.window.location.href = "gift.html";
            },4000);
        }

        heartBeatAnimation = (step) => {
            var width = this.heart.width;
            var height = this.heart.height;
            var canvasW = this.gamesData.canvasWidth();
            var canvasH = this.gamesData.canvasHeight();
            this.context.fillStyle = `rgb(128,128,128)`;
            this.context.fillRect(0, 0, this.gamesData.canvasWidth(), this.gamesData.canvasHeight());
            
            this.context.drawImage(this.perso,
            canvasW/4-32,canvasH/2-32);
            
            this.context.drawImage(this.perso2,
            (canvasW*3)/4 - 32,canvasH/2-32);

            if (step){
            this.context.drawImage(this.heart, 0,0,width,height,
            canvasW/2 - width,canvasH/2 - height, width*2,height*2);
            }
            else
            {
                this.context.drawImage(this.heart, 0,0,width,height,
                canvasW/2 - width*2,canvasH/2 - height*2, width*4,height*4);
            }
            step = !step;
            setTimeout(()=>{
                heartBeatAnimation(step)
            },300)
            
        }
        

        fadeOut = (params) => {
           
                params.status = params.status + params.step;
                if (params.status > 1) {
                    params.status = 1;
                }
                this.context.fillStyle = `rgba(128,128,128,${params.status})`;
                this.context.fillRect(0, 0, this.gamesData.canvasWidth(), this.gamesData.canvasHeight());
                var padControl = document.getElementById('pad-control');
                padControl.classList.add('hidden');
                if (params.status < 1) {
                    requestAnimationFrame(() => fadeOut(params));
                }
                else{
                    params.callback();
                }
           
        }
    </script>
</body>

</html>